"use strict";(()=>{var e={};e.id=642,e.ids=[642],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55146:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>S,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>y,staticGenerationAsyncStorage:()=>c});var r={};a.r(r),a.d(r,{GET:()=>u,dynamic:()=>l});var n=a(49303),i=a(88716),o=a(60670),s=a(87070),p=a(4589);let l="force-dynamic";async function u(e){try{let t=e.nextUrl.searchParams.get("startDate"),a=e.nextUrl.searchParams.get("endDate");if(!t||!a)return s.NextResponse.json({error:"Missing date parameters"},{status:400});let r=new Date(t),n=new Date(a);if(isNaN(r.getTime())||isNaN(n.getTime()))return s.NextResponse.json({error:"Invalid date format"},{status:400});await (0,p.Wq)();let i=await (0,p.M8)(r,n);return s.NextResponse.json({availability:Object.fromEntries(i)})}catch(e){return console.error("Bulk availability error:",e),s.NextResponse.json({error:"Failed to fetch availability"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bookings/availability/bulk/route",pathname:"/api/bookings/availability/bulk",filename:"route",bundlePath:"app/api/bookings/availability/bulk/route"},resolvedPagePath:"/home/enock/Soka-Zone/app/api/bookings/availability/bulk/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:c,serverHooks:y}=d,g="/api/bookings/availability/bulk/route";function S(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:c})}},4589:(e,t,a)=>{a.d(t,{M8:()=>o,Wq:()=>s,Xs:()=>i});var r=a(2021),n=a(73431);async function i(e,t){await (0,r.Z)();let a=new Date(e);a.setHours(0,0,0,0);let i=new Date(e);i.setHours(23,59,59,999);let o=await n.Z.find({date:{$gte:a,$lte:i},paymentStatus:{$nin:["failed","cancelled","expired"]},$or:[{paymentStatus:"completed"},{paymentStatus:"pending",paymentHoldExpiresAt:{$gt:new Date}}]}).select("startTime endTime duration"),s=[];for(let e=6;e<=22-t;e++){let a=`${e.toString().padStart(2,"0")}:00`,r=`${(e+t).toString().padStart(2,"0")}:00`,n=!o.some(a=>{let r=parseInt(a.startTime.split(":")[0]),n=r+a.duration;return e>=r&&e<n||e+t>r&&e+t<=n||e<=r&&e+t>=n});s.push({startTime:a,endTime:r,available:n})}return s}async function o(e,t){await (0,r.Z)();let a=await n.Z.find({date:{$gte:e,$lte:t},paymentStatus:{$nin:["failed","cancelled","expired"]},$or:[{paymentStatus:"completed"},{paymentStatus:"pending",paymentHoldExpiresAt:{$gt:new Date}}]}).select("date"),i=new Map,o=new Date(e);for(;o<=t;){let e=o.toISOString().split("T")[0],t=a.some(t=>t.date.toISOString().split("T")[0]===e);i.set(e,!t),o.setDate(o.getDate()+1)}return i}async function s(){return await (0,r.Z)(),(await n.Z.updateMany({paymentStatus:"pending",paymentHoldExpiresAt:{$lt:new Date}},{$set:{paymentStatus:"expired"}})).modifiedCount}},2021:(e,t,a)=>{a.d(t,{Z:()=>s});var r=a(11185),n=a.n(r);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let o=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=o);let s=async function(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(i,{bufferCommands:!1}).then(e=>e));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}},73431:(e,t,a)=>{a.d(t,{Z:()=>o});var r=a(11185),n=a.n(r);let i=new r.Schema({user:{type:r.Schema.Types.ObjectId,ref:"User",required:!1},pitch:{type:r.Schema.Types.ObjectId,ref:"Pitch",required:!0},date:{type:Date,required:!0},startTime:{type:String,required:!0},endTime:{type:String,required:!0},duration:{type:Number,required:!0},totalPrice:{type:Number,required:!0},paymentMethod:{type:String,enum:["momo","visa"],required:!0},paymentStatus:{type:String,enum:["pending","completed","failed","cancelled","expired"],default:"pending",required:!0},confirmationCode:{type:String,required:!0,unique:!0},customerName:{type:String,required:!0},customerEmail:{type:String,required:!0},customerPhone:{type:String,required:!0},notes:{type:String},paymentTransactionId:{type:String,sparse:!0,index:!0},paymentProvider:{type:String,enum:["flutterwave","stripe"],required:!1},paymentVerifiedAt:{type:Date,required:!1},paymentHoldExpiresAt:{type:Date,required:!0,index:!0}},{timestamps:!0});i.index({date:1,paymentStatus:1}),i.index({paymentHoldExpiresAt:1,paymentStatus:1});let o=n().models.Booking||n().model("Booking",i)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(55146));module.exports=r})();