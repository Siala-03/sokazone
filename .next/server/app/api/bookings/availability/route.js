"use strict";(()=>{var e={};e.id=185,e.ids=[185],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},71285:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>y,serverHooks:()=>f,staticGenerationAsyncStorage:()=>S});var a={};r.r(a),r.d(a,{GET:()=>c,POST:()=>m,dynamic:()=>u});var n=r(49303),i=r(88716),o=r(60670),s=r(87070),p=r(2021),l=r(73431),d=r(4589);let u="force-dynamic";async function m(e){try{await (0,p.Z)();let{pitchId:t,date:r,startTime:a,endTime:n}=await e.json();if(!t||!r||!a||!n)return s.NextResponse.json({error:"Please provide all required fields"},{status:400});let i=await l.Z.findOne({pitch:t,date:new Date(r),$or:[{startTime:{$lte:a},endTime:{$gt:a}},{startTime:{$lt:n},endTime:{$gte:n}},{startTime:{$gte:a},endTime:{$lte:n}}],paymentStatus:{$ne:"failed"}});return s.NextResponse.json({available:!i},{status:200})}catch(e){return console.error("Check availability error:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e){try{let t=e.nextUrl.searchParams.get("date"),r=e.nextUrl.searchParams.get("duration");if(!t||!r)return s.NextResponse.json({error:"Missing parameters"},{status:400});let a=new Date(t),n=parseInt(r);if(isNaN(a.getTime())||![2,3].includes(n))return s.NextResponse.json({error:"Invalid parameters"},{status:400});await (0,d.Wq)();let i=await (0,d.Xs)(a,n);return s.NextResponse.json({slots:i})}catch(e){return console.error("Availability error:",e),s.NextResponse.json({error:"Failed to fetch availability"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bookings/availability/route",pathname:"/api/bookings/availability",filename:"route",bundlePath:"app/api/bookings/availability/route"},resolvedPagePath:"/home/enock/Soka-Zone/app/api/bookings/availability/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:S,serverHooks:f}=y,v="/api/bookings/availability/route";function x(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:S})}},4589:(e,t,r)=>{r.d(t,{M8:()=>o,Wq:()=>s,Xs:()=>i});var a=r(2021),n=r(73431);async function i(e,t){await (0,a.Z)();let r=new Date(e);r.setHours(0,0,0,0);let i=new Date(e);i.setHours(23,59,59,999);let o=await n.Z.find({date:{$gte:r,$lte:i},paymentStatus:{$nin:["failed","cancelled","expired"]},$or:[{paymentStatus:"completed"},{paymentStatus:"pending",paymentHoldExpiresAt:{$gt:new Date}}]}).select("startTime endTime duration"),s=[];for(let e=6;e<=22-t;e++){let r=`${e.toString().padStart(2,"0")}:00`,a=`${(e+t).toString().padStart(2,"0")}:00`,n=!o.some(r=>{let a=parseInt(r.startTime.split(":")[0]),n=a+r.duration;return e>=a&&e<n||e+t>a&&e+t<=n||e<=a&&e+t>=n});s.push({startTime:r,endTime:a,available:n})}return s}async function o(e,t){await (0,a.Z)();let r=await n.Z.find({date:{$gte:e,$lte:t},paymentStatus:{$nin:["failed","cancelled","expired"]},$or:[{paymentStatus:"completed"},{paymentStatus:"pending",paymentHoldExpiresAt:{$gt:new Date}}]}).select("date"),i=new Map,o=new Date(e);for(;o<=t;){let e=o.toISOString().split("T")[0],t=r.some(t=>t.date.toISOString().split("T")[0]===e);i.set(e,!t),o.setDate(o.getDate()+1)}return i}async function s(){return await (0,a.Z)(),(await n.Z.updateMany({paymentStatus:"pending",paymentHoldExpiresAt:{$lt:new Date}},{$set:{paymentStatus:"expired"}})).modifiedCount}},2021:(e,t,r)=>{r.d(t,{Z:()=>s});var a=r(11185),n=r.n(a);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let o=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=o);let s=async function(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(i,{bufferCommands:!1}).then(e=>e));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}},73431:(e,t,r)=>{r.d(t,{Z:()=>o});var a=r(11185),n=r.n(a);let i=new a.Schema({user:{type:a.Schema.Types.ObjectId,ref:"User",required:!1},pitch:{type:a.Schema.Types.ObjectId,ref:"Pitch",required:!0},date:{type:Date,required:!0},startTime:{type:String,required:!0},endTime:{type:String,required:!0},duration:{type:Number,required:!0},totalPrice:{type:Number,required:!0},paymentMethod:{type:String,enum:["momo","visa"],required:!0},paymentStatus:{type:String,enum:["pending","completed","failed","cancelled","expired"],default:"pending",required:!0},confirmationCode:{type:String,required:!0,unique:!0},customerName:{type:String,required:!0},customerEmail:{type:String,required:!0},customerPhone:{type:String,required:!0},notes:{type:String},paymentTransactionId:{type:String,sparse:!0,index:!0},paymentProvider:{type:String,enum:["flutterwave","stripe"],required:!1},paymentVerifiedAt:{type:Date,required:!1},paymentHoldExpiresAt:{type:Date,required:!0,index:!0}},{timestamps:!0});i.index({date:1,paymentStatus:1}),i.index({paymentHoldExpiresAt:1,paymentStatus:1});let o=n().models.Booking||n().model("Booking",i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972],()=>r(71285));module.exports=a})();