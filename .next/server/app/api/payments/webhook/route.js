"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},98484:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{POST:()=>l});var o=r(49303),i=r(88716),a=r(60670),s=r(87070),u=r(2021),c=r(73431),d=r(77938),p=r(2239);async function l(e){let t=e.nextUrl.searchParams.get("provider");if(!t||!["flutterwave","stripe"].includes(t))return s.NextResponse.json({error:"Invalid provider"},{status:400});try{if(await (0,u.Z)(),"flutterwave"===t){let t=e.headers.get("verif-hash"),r=await e.json();if(!t||!(0,d.Tb)(t))return console.error("Flutterwave webhook signature verification failed"),s.NextResponse.json({error:"Invalid signature"},{status:401});if("charge.completed"===r.event&&"successful"===r.data.status){let e=r.data.meta.booking_id,t=await c.Z.findById(e);t&&"pending"===t.paymentStatus&&(t.paymentStatus="completed",t.paymentVerifiedAt=new Date,await t.save())}}else if("stripe"===t){let t=e.headers.get("stripe-signature"),r=await e.text();if(!t)return s.NextResponse.json({error:"No signature"},{status:401});let n=(0,p.$t)(r,t);if(!n)return s.NextResponse.json({error:"Invalid signature"},{status:401});if("payment_intent.succeeded"===n.type){let e=n.data.object.metadata.booking_id,t=await c.Z.findById(e);t&&"pending"===t.paymentStatus&&(t.paymentStatus="completed",t.paymentVerifiedAt=new Date,await t.save())}}return s.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),s.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"/home/enock/Soka-Zone/app/api/payments/webhook/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:g}=m,h="/api/payments/webhook/route";function v(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},2021:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),o=r.n(n);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let a=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=a);let s=async function(){if(a.conn)return a.conn;a.promise||(a.promise=o().connect(i,{bufferCommands:!1}).then(e=>e));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}},77938:(e,t,r)=>{r.d(t,{Bw:()=>s,Tb:()=>c,s0:()=>u});var n=r(56344),o=r.n(n);let i=null;function a(){if(!i){let e=process.env.FLUTTERWAVE_PUBLIC_KEY,t=process.env.FLUTTERWAVE_SECRET_KEY;if(!e||!t)throw Error("Flutterwave credentials not configured");i=new(o())(e,t)}return i}async function s(e){let t={tx_ref:`SOKA-${e.bookingId}-${Date.now()}`,amount:e.amount,currency:e.currency,redirect_url:`http://localhost:3000/booking/confirmation?bookingId=${e.bookingId}`,payment_options:e.paymentMethod,customer:{email:e.email,phonenumber:e.phone,name:e.name},customizations:{title:"Soka Zone Booking Payment",description:`Football field booking - ${e.bookingId}`,logo:"http://localhost:3000/logo.png"},meta:{booking_id:e.bookingId}};try{let r;let n=a();r="mobilemoneyrwanda"===e.paymentMethod?await n.MobileMoney.rwanda({...t,fullname:e.name}):await n.PaymentLink.create(t);let o=r.data?.link||r.meta?.authorization?.redirect,i=r.data?.id?.toString()||t.tx_ref;if(!o)throw Error("Payment URL not received from Flutterwave");return{success:!0,paymentUrl:o,transactionId:i}}catch(e){return console.error("Flutterwave initialization error:",e),{success:!1,error:e.message||"Payment initialization failed"}}}async function u(e){try{let t=a(),r=await t.Transaction.verify({id:e});if("successful"===r.data.status&&r.data.amount>=0)return{success:!0,verified:!0,transactionId:r.data.id,amount:r.data.amount,bookingId:r.data.meta.booking_id};return{success:!0,verified:!1}}catch(e){return console.error("Flutterwave verification error:",e),{success:!1,error:e.message}}}function c(e){return e===(process.env.FLUTTERWAVE_SECRET_HASH||process.env.FLUTTERWAVE_SECRET_KEY)}},2239:(e,t,r)=>{r.d(t,{$t:()=>u,Qh:()=>s,eA:()=>a});var n=r(39256);let o=null;function i(){if(!o){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("Stripe credentials not configured");o=new n.Z(e,{apiVersion:"2025-02-24.acacia"})}return o}async function a(e){try{let t=i(),r=await t.paymentIntents.create({amount:Math.round(100*e.amount),currency:e.currency.toLowerCase(),receipt_email:e.email,metadata:{booking_id:e.bookingId,customer_name:e.name},automatic_payment_methods:{enabled:!0}});return{success:!0,clientSecret:r.client_secret,transactionId:r.id}}catch(e){return console.error("Stripe payment intent error:",e),{success:!1,error:e.message||"Payment initialization failed"}}}async function s(e){try{let t=i(),r=await t.paymentIntents.retrieve(e);if("succeeded"===r.status)return{success:!0,verified:!0,transactionId:r.id,amount:r.amount/100,bookingId:r.metadata.booking_id};return{success:!0,verified:!1,status:r.status}}catch(e){return console.error("Stripe verification error:",e),{success:!1,error:e.message}}}function u(e,t){try{let r=i(),n=process.env.STRIPE_WEBHOOK_SECRET;if(!n)throw Error("Stripe webhook secret not configured");return r.webhooks.constructEvent(e,t,n)}catch(e){return console.error("Stripe webhook verification failed:",e),null}}},73431:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(11185),o=r.n(n);let i=new n.Schema({user:{type:n.Schema.Types.ObjectId,ref:"User",required:!1},pitch:{type:n.Schema.Types.ObjectId,ref:"Pitch",required:!0},date:{type:Date,required:!0},startTime:{type:String,required:!0},endTime:{type:String,required:!0},duration:{type:Number,required:!0},totalPrice:{type:Number,required:!0},paymentMethod:{type:String,enum:["momo","visa"],required:!0},paymentStatus:{type:String,enum:["pending","completed","failed","cancelled","expired"],default:"pending",required:!0},confirmationCode:{type:String,required:!0,unique:!0},customerName:{type:String,required:!0},customerEmail:{type:String,required:!0},customerPhone:{type:String,required:!0},notes:{type:String},paymentTransactionId:{type:String,sparse:!0,index:!0},paymentProvider:{type:String,enum:["flutterwave","stripe"],required:!1},paymentVerifiedAt:{type:Date,required:!1},paymentHoldExpiresAt:{type:Date,required:!0,index:!0}},{timestamps:!0});i.index({date:1,paymentStatus:1}),i.index({paymentHoldExpiresAt:1,paymentStatus:1});let a=o().models.Booking||o().model("Booking",i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972,605],()=>r(98484));module.exports=n})();