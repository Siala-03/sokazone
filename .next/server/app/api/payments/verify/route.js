"use strict";(()=>{var e={};e.id=999,e.ids=[999],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},95074:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{GET:()=>m});var i=r(49303),o=r(88716),a=r(60670),s=r(87070),u=r(2021),c=r(73431),d=r(77938),p=r(2239);let l=(0,r(35860).h)({interval:6e4,maxRequests:10});async function m(e){let t=await l(e);if(t)return t;try{let t=e.nextUrl.searchParams.get("bookingId"),r=e.nextUrl.searchParams.get("transactionId");if(!t)return s.NextResponse.json({error:"Missing bookingId"},{status:400});await (0,u.Z)();let n=await c.Z.findById(t);if(!n)return s.NextResponse.json({error:"Booking not found"},{status:404});if("completed"===n.paymentStatus)return s.NextResponse.json({status:"completed",verified:!0,booking:n});if(new Date>n.paymentHoldExpiresAt)return n.paymentStatus="expired",await n.save(),s.NextResponse.json({status:"expired",verified:!1});if(r){let e;if("flutterwave"===n.paymentProvider?e=await (0,d.s0)(r):"stripe"===n.paymentProvider&&(e=await (0,p.Qh)(r)),e?.success&&e.verified)return n.paymentStatus="completed",n.paymentVerifiedAt=new Date,await n.save(),s.NextResponse.json({status:"completed",verified:!0,booking:n})}return s.NextResponse.json({status:n.paymentStatus,verified:!1})}catch(e){return console.error("Payment verification error:",e),s.NextResponse.json({error:"Verification failed"},{status:500})}}let y=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payments/verify/route",pathname:"/api/payments/verify",filename:"route",bundlePath:"app/api/payments/verify/route"},resolvedPagePath:"/home/enock/Soka-Zone/app/api/payments/verify/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:h}=y,v="/api/payments/verify/route";function x(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},2021:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),i=r.n(n);let o=process.env.MONGODB_URI;if(!o)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let a=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=a);let s=async function(){if(a.conn)return a.conn;a.promise||(a.promise=i().connect(o,{bufferCommands:!1}).then(e=>e));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}},77938:(e,t,r)=>{r.d(t,{Bw:()=>s,Tb:()=>c,s0:()=>u});var n=r(56344),i=r.n(n);let o=null;function a(){if(!o){let e=process.env.FLUTTERWAVE_PUBLIC_KEY,t=process.env.FLUTTERWAVE_SECRET_KEY;if(!e||!t)throw Error("Flutterwave credentials not configured");o=new(i())(e,t)}return o}async function s(e){let t={tx_ref:`SOKA-${e.bookingId}-${Date.now()}`,amount:e.amount,currency:e.currency,redirect_url:`http://localhost:3000/booking/confirmation?bookingId=${e.bookingId}`,payment_options:e.paymentMethod,customer:{email:e.email,phonenumber:e.phone,name:e.name},customizations:{title:"Soka Zone Booking Payment",description:`Football field booking - ${e.bookingId}`,logo:"http://localhost:3000/logo.png"},meta:{booking_id:e.bookingId}};try{let r;let n=a();r="mobilemoneyrwanda"===e.paymentMethod?await n.MobileMoney.rwanda({...t,fullname:e.name}):await n.PaymentLink.create(t);let i=r.data?.link||r.meta?.authorization?.redirect,o=r.data?.id?.toString()||t.tx_ref;if(!i)throw Error("Payment URL not received from Flutterwave");return{success:!0,paymentUrl:i,transactionId:o}}catch(e){return console.error("Flutterwave initialization error:",e),{success:!1,error:e.message||"Payment initialization failed"}}}async function u(e){try{let t=a(),r=await t.Transaction.verify({id:e});if("successful"===r.data.status&&r.data.amount>=0)return{success:!0,verified:!0,transactionId:r.data.id,amount:r.data.amount,bookingId:r.data.meta.booking_id};return{success:!0,verified:!1}}catch(e){return console.error("Flutterwave verification error:",e),{success:!1,error:e.message}}}function c(e){return e===(process.env.FLUTTERWAVE_SECRET_HASH||process.env.FLUTTERWAVE_SECRET_KEY)}},2239:(e,t,r)=>{r.d(t,{$t:()=>u,Qh:()=>s,eA:()=>a});var n=r(39256);let i=null;function o(){if(!i){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("Stripe credentials not configured");i=new n.Z(e,{apiVersion:"2025-02-24.acacia"})}return i}async function a(e){try{let t=o(),r=await t.paymentIntents.create({amount:Math.round(100*e.amount),currency:e.currency.toLowerCase(),receipt_email:e.email,metadata:{booking_id:e.bookingId,customer_name:e.name},automatic_payment_methods:{enabled:!0}});return{success:!0,clientSecret:r.client_secret,transactionId:r.id}}catch(e){return console.error("Stripe payment intent error:",e),{success:!1,error:e.message||"Payment initialization failed"}}}async function s(e){try{let t=o(),r=await t.paymentIntents.retrieve(e);if("succeeded"===r.status)return{success:!0,verified:!0,transactionId:r.id,amount:r.amount/100,bookingId:r.metadata.booking_id};return{success:!0,verified:!1,status:r.status}}catch(e){return console.error("Stripe verification error:",e),{success:!1,error:e.message}}}function u(e,t){try{let r=o(),n=process.env.STRIPE_WEBHOOK_SECRET;if(!n)throw Error("Stripe webhook secret not configured");return r.webhooks.constructEvent(e,t,n)}catch(e){return console.error("Stripe webhook verification failed:",e),null}}},35860:(e,t,r)=>{r.d(t,{h:()=>o});var n=r(87070);let i={};function o(e){let{interval:t,maxRequests:r}=e;return async e=>{let o=e.headers.get("x-forwarded-for"),a=o?o.split(",")[0]:e.headers.get("x-real-ip")||"unknown",s=Date.now(),u=`${a}:${e.nextUrl.pathname}`;if(i[u]&&i[u].resetTime<s&&delete i[u],!i[u])return i[u]={count:1,resetTime:s+t},null;if(i[u].count++,i[u].count>r){let e=Math.ceil((i[u].resetTime-s)/1e3);return n.NextResponse.json({error:"Too many requests",message:`Rate limit exceeded. Try again in ${e} seconds.`,retryAfter:e},{status:429,headers:{"Retry-After":e.toString(),"X-RateLimit-Limit":r.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":i[u].resetTime.toString()}})}return null}}setInterval(()=>{let e=Date.now();Object.keys(i).forEach(t=>{i[t].resetTime<e&&delete i[t]})},6e5)},73431:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(11185),i=r.n(n);let o=new n.Schema({user:{type:n.Schema.Types.ObjectId,ref:"User",required:!1},pitch:{type:n.Schema.Types.ObjectId,ref:"Pitch",required:!0},date:{type:Date,required:!0},startTime:{type:String,required:!0},endTime:{type:String,required:!0},duration:{type:Number,required:!0},totalPrice:{type:Number,required:!0},paymentMethod:{type:String,enum:["momo","visa"],required:!0},paymentStatus:{type:String,enum:["pending","completed","failed","cancelled","expired"],default:"pending",required:!0},confirmationCode:{type:String,required:!0,unique:!0},customerName:{type:String,required:!0},customerEmail:{type:String,required:!0},customerPhone:{type:String,required:!0},notes:{type:String},paymentTransactionId:{type:String,sparse:!0,index:!0},paymentProvider:{type:String,enum:["flutterwave","stripe"],required:!1},paymentVerifiedAt:{type:Date,required:!1},paymentHoldExpiresAt:{type:Date,required:!0,index:!0}},{timestamps:!0});o.index({date:1,paymentStatus:1}),o.index({paymentHoldExpiresAt:1,paymentStatus:1});let a=i().models.Booking||i().model("Booking",o)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972,605],()=>r(95074));module.exports=n})();